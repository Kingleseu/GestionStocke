{% extends 'base.html' %}
{% load static %}

{% block title %}Ticket #{{ sale.id }} - MKARIBU{% endblock %}

{% block extra_css %}
<style>
    .receipt-container {
        max-width: 450px;
        margin: 2rem auto;
        background: white;
        padding: 1.5rem;
        border: 1px solid #eee;
        color: #000;
        font-family: 'Courier New', Courier, monospace;
    }

    .receipt-header {
        text-align: center;
        margin-bottom: 1rem;
    }

    .receipt-total {
        margin-top: 1rem;
    }

    @media print {
        body * {
            visibility: hidden;
        }

        .receipt-container,
        .receipt-container * {
            visibility: visible;
        }

        .receipt-container {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            box-shadow: none;
        }

        .no-print {
            display: none !important;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="receipt-container mx-auto">
        <!-- Header Section -->
        <div class="receipt-header text-center">
            <h4 class="mb-1 font-weight-bold" style="font-size: 1.25rem;"><strong>{{ shop.name }}</strong></h4>
            <p class="mb-0 small">{{ shop.address|default:'' }}</p>
            {% if shop.rccm %}<p class="mb-0 small">RCCM : {{ shop.rccm }}</p>{% endif %}
            {% if shop.id_nat %}<p class="mb-0 small">ID.NAT : {{ shop.id_nat }}</p>{% endif %}
            {% if shop.nif %}<p class="mb-0 small">NIF : {{ shop.nif }}</p>{% endif %}
            {% if shop.bureau %}<p class="mb-0 small">Bureau - {{ shop.bureau }}</p>{% endif %}
            <p class="mb-0 small">DR Congo</p>
            {% if shop.phone %}<p class="mb-0 small">{{ shop.phone }}</p>{% endif %}
            {% if shop.email %}<p class="mb-0 small">{{ shop.email }}</p>{% endif %}
        </div>

        <div class="text-center my-2">
            <div style="border-top: 2px dotted #000; margin: 5px 0;"></div>
            <h5 class="m-0 py-1" style="letter-spacing: 2px;">FACTURE</h5>
            <div style="border-top: 2px dotted #000; margin: 5px 0;"></div>
        </div>

        <!-- Invoice Info -->
        <div class="mb-3 small">
            <div class="d-flex justify-content-between">
                <span>N° de facture</span>
                <span>NIV{{ sale.id|stringformat:"04d" }}</span>
            </div>
            <div class="d-flex justify-content-between">
                <span>Date</span>
                <span>{{ sale.sale_date|date:"d.m.Y" }}</span>
            </div>
            <div class="d-flex justify-content-between">
                <span>Client :</span>
                <span>{{ sale.notes|default:"Passager" }}</span>
            </div>
        </div>

        <div style="border-top: 2px dotted #000; margin: 10px 0;"></div>

        <!-- Items Table -->
        <table class="table table-borderless table-sm small mb-0">
            <thead>
                <tr style="border-bottom: 1px dotted #000;">
                    <th class="ps-0">#</th>
                    <th>Article</th>
                    <th class="text-center">Quantité</th>
                    <th class="text-end">Taux</th>
                    <th class="text-end pe-0">Montant</th>
                </tr>
            </thead>
            <tbody>
                {% for item in items %}
                <tr>
                    <td class="ps-0">{{ forloop.counter }}</td>
                    <td>{{ item.obj.product.name }}</td>
                    <td class="text-center">{{ item.obj.quantity|floatformat:2 }}</td>
                    <td class="text-end">{{ item.unit_price|floatformat:2 }}</td>
                    <td class="text-end pe-0">{{ item.subtotal|floatformat:2 }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <div style="border-top: 1px dotted #000; margin: 5px 0;"></div>

        <!-- Subtotal & VAT -->
        <div class="small w-100 ps-4">
            <div class="d-flex justify-content-between">
                <span style="margin-left: auto;">Sous-total (HT)</span>
                <span class="text-end" style="width: 100px;">{{ total_ht_cdf|floatformat:2 }}</span>
            </div>
            <div class="d-flex justify-content-between">
                <span style="margin-left: auto;">TVA ({{ vat_rate_pct }}%)</span>
                <span class="text-end" style="width: 100px;">{{ vat_amount_cdf|floatformat:2 }}</span>
            </div>
        </div>

        <div style="border-top: 2px solid #000; margin: 10px 0;"></div>

        <!-- Total Section -->
        <div class="d-flex justify-content-between align-items-center py-2">
            <h3 class="m-0"><strong>TOTAL</strong></h3>
            <div class="text-end">
                <h3 class="m-0"><strong>CDF {{ total_ttc_cdf|floatformat:2 }}</strong></h3>
            </div>
        </div>

        <div style="border-top: 2px solid #000; margin: 10px 0;"></div>

        <!-- Footer -->
        <div class="text-center small px-2 mt-4">
            <p>Merci de votre confiance. Nous aurions le plaisir de collaborer de nouveau avec vous dans un futur
                proche.</p>
        </div>

        <!-- Action Buttons (no-print) -->
        <div class="no-print mt-4 d-grid gap-2">
            <button onclick="window.print()" class="btn btn-dark btn-lg">
                <i class="bi bi-printer"></i> Imprimer la facture
            </button>
            <a href="{% url 'sales:pos' %}" class="btn btn-outline-dark">
                <i class="bi bi-arrow-left"></i> Retour à la caisse
            </a>
        </div>
    </div>
</div>
{% endblock %}