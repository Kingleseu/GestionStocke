{% extends 'base.html' %}
{% load static %}

{% block title %}Caisse - MKARIBU{% endblock %}

{% block content %}
<!-- POS Container (Full Height fixed) -->
<div class="pos-container">

    <!-- LEFT: Products Area -->
    <div class="pos-products-area">
        <!-- Search & Scanner Bar -->
        <div class="d-flex gap-2 mb-4">
            <div class="input-group input-group-lg flex-grow-1">
                <span class="input-group-text bg-white border-end-0"><i class="bi bi-search text-muted"></i></span>
                <input type="text" id="searchInput" class="form-control border-start-0 ps-0"
                    placeholder="Scanner ou taper le produit..." autocomplete="off" autofocus>
            </div>
            <button class="btn btn-primary btn-lg" type="button" onclick="startScanner()" title="Scanner">
                <i class="bi bi-qr-code-scan"></i>
            </button>
        </div>
        <div id="searchResults" class="search-results position-absolute bg-white shadow-lg rounded p-0"
            style="display:none; z-index: 1000; width: 400px; max-height: 400px; overflow-y: auto;"></div>

        <!-- Categories -->
        <div class="category-pills no-scrollbar">
            <div class="category-pill active" onclick="filterCategory('all', this)">Tout</div>
            {% for category in categories %}
            <div class="category-pill" onclick="filterCategory('{{ category.id }}', this)">
                {{ category.name }}
            </div>
            {% endfor %}
        </div>

        <!-- Product Grid -->
        <h5 class="fw-bold mb-3 text-secondary">Produits</h5>
        <div class="product-grid" id="productGrid">
            {% for product in products %}
            <div class="pos-product-card card h-100 {% if product.current_stock == 0 %}opacity-50{% endif %}"
                data-id="{{ product.id|default:0 }}" data-name="{{ product.name }}"
                data-price="{{ product.selling_price|default:0|stringformat:'f' }}"
                data-stock="{{ product.current_stock|default:0 }}"
                data-category="{{ product.category.id|default:'none' }}" onclick="handleProductClick(this)">

                {% if product.image %}
                <img src="{{ product.image.url }}" alt="{{ product.name }}">
                {% else %}
                <div class="bg-light d-flex align-items-center justify-content-center"
                    style="height: 120px; width: 100%;">
                    <i class="bi bi-box text-muted" style="font-size: 2.5rem;"></i>
                </div>
                {% endif %}

                <div class="pos-product-details">
                    <div class="fw-bold text-dark text-truncate mb-1" title="{{ product.name }}">{{ product.name }}
                    </div>
                    <div class="d-flex justify-content-between align-items-center mt-auto">
                        <span class="pos-price">{{ product.selling_price }}$</span>
                        <span
                            class="badge {% if product.current_stock == 0 %}bg-danger{% elif product.is_low_stock %}bg-warning{% else %}bg-success{% endif %} bg-opacity-10 text-dark rounded-pill"
                            style="font-size: 0.7rem;">
                            Stock: {{ product.current_stock }}
                        </span>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="col-12 text-center text-muted py-5">
                <i class="bi bi-box-seam display-4 mb-3 d-block"></i>
                Aucun produit trouvé
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- RIGHT: Cart Area -->
    <div class="pos-cart-area shadow-lg">
        <div class="cart-header bg-white d-flex align-items-center justify-content-between">
            <h5 class="fw-bold mb-0 text-dark"><i class="bi bi-cart3 me-2 text-primary"></i>Panier</h5>
            <button class="btn btn-sm btn-light text-danger" onclick="clearCart()" title="Vider">
                <i class="bi bi-trash"></i>
            </button>
        </div>

        <div class="cart-items bg-light" id="cartItems">
            <!-- Items injected by JS -->
            <div class="text-center text-muted py-5 mt-5">
                <i class="bi bi-cart-x display-1 opacity-25"></i>
                <p class="mt-3 fw-medium">Votre panier est vide</p>
            </div>
        </div>

        <div class="cart-footer bg-white shadow-top">
            <div class="mb-3">
                <label class="form-label text-muted small fw-bold text-uppercase">Mode de paiement</label>
                <div class="d-flex gap-2 payment-options">
                    <select id="paymentMethod" class="form-select border-2">
                        {% for code, label in payment_methods %}
                        <option value="{{ code }}">{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="d-flex justify-content-between align-items-center mb-3">
                <span class="text-muted">Total à payer</span>
                <span class="total-display text-primary mb-0" id="totalAmount">0.00$</span>
            </div>

            <button
                class="btn btn-primary w-100 py-3 fs-5 fw-bold d-flex align-items-center justify-content-center gap-2"
                id="validateBtn" onclick="validateSale()" disabled>
                <span>Valider la Vente</span>
                <i class="bi bi-arrow-right"></i>
            </button>
        </div>
    </div>
</div>

<!-- Scanner Overlay -->
<div id="scanner-overlay"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2000; background-color: rgba(0,0,0,0.95);">
    <div class="d-flex flex-column h-100 justify-content-center align-items-center position-relative">
        <button type="button" class="btn btn-lg text-white position-absolute top-0 end-0 m-4" onclick="stopScanner()">
            <i class="bi bi-x-lg display-6"></i>
        </button>
        <h3 class="text-white mb-4"><i class="bi bi-qr-code-scan me-2"></i>Scanner le produit</h3>
        <div id="reader"
            style="width: 100%; max-width: 500px; border-radius: 20px; overflow: hidden; border: 4px solid var(--primary);">
        </div>
    </div>
</div>

<!-- Modal de Feedback Scan -->
<div class="modal fade" id="scanFeedbackModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static"
    data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content border-0 shadow-lg text-center p-4 rounded-4">
            <div class="mb-3">
                <i id="scanFeedbackIcon" class="bi bi-check-circle-fill display-1 text-success"></i>
            </div>
            <h4 id="scanFeedbackTitle" class="fw-bold mb-2">Ajouté !</h4>
            <div id="scanFeedbackContent" class="text-muted"></div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<script>
    // ==========================================
    // CORE POS LOGIC
    // ==========================================
    let cart = [];

    // Filter Categories
    function filterCategory(categoryId, element) {
        // UI
        document.querySelectorAll('.category-pill').forEach(el => el.classList.remove('active'));
        if (element) element.classList.add('active');

        // Logic
        const cards = document.querySelectorAll('.pos-product-card');
        cards.forEach(card => {
            if (categoryId === 'all' || card.dataset.category === categoryId) {
                card.style.display = 'flex'; // Restore card display
            } else {
                card.style.display = 'none';
            }
        });
    }

    // Search Logic
    let searchTimeout;
    document.getElementById('searchInput').addEventListener('input', function (e) {
        clearTimeout(searchTimeout);
        const query = e.target.value.trim().toLowerCase();

        // Local filtering first (Grid)
        const cards = document.querySelectorAll('.pos-product-card');
        let hasVisible = false;
        cards.forEach(card => {
            const name = card.dataset.name.toLowerCase();
            if (name.includes(query)) {
                card.style.display = 'flex';
                hasVisible = true;
            } else {
                card.style.display = 'none';
            }
        });

        // Remote search for barcode/etc if no match or strict specific
        if (query.length >= 2) {
            // Optional: Show dropdown for distinct results from server if needed 
            // avoiding complexity for now, local filter is fast for loaded products
        }
    });

    // Handle Click
    function handleProductClick(element) {
        // Animation
        element.style.transform = 'scale(0.95)';
        setTimeout(() => element.style.transform = '', 100);

        const id = parseInt(element.dataset.id);
        const name = element.dataset.name;
        const price = parseFloat(element.dataset.price.replace(',', '.'));
        const stock = parseInt(element.dataset.stock);
        addToCart(id, name, price, stock);
    }

    // Cart Logic
    function addToCart(productId, productName, price, stock) {
        if (stock <= 0) {
            showToast('error', 'Rupture', 'Ce produit est épuisé.');
            return;
        }

        const existingItem = cart.find(item => item.product_id === productId);

        if (existingItem) {
            if (existingItem.quantity >= stock) {
                showToast('warning', 'Stock', `Max disponible : ${stock}`);
                return;
            }
            existingItem.quantity++;
        } else {
            cart.push({
                product_id: productId,
                name: productName,
                price: price,
                quantity: 1,
                stock: stock
            });
        }
        updateCart();
    }

    function updateCart() {
        const cartItemsDiv = document.getElementById('cartItems');
        const countEl = document.getElementById('itemCount'); // Helper if needed

        if (cart.length === 0) {
            cartItemsDiv.innerHTML = `
            <div class="text-center text-muted py-5 mt-4">
                <i class="bi bi-cart-x display-4 opacity-50"></i>
                <p class="mt-3 small">Votre panier est vide</p>
            </div>`;
            document.getElementById('validateBtn').disabled = true;
        } else {
            cartItemsDiv.innerHTML = cart.map((item, index) => `
            <div class="cart-item">
                <div class="flex-grow-1">
                    <div class="fw-bold text-dark">${item.name}</div>
                    <div class="text-muted small">${item.price}$ / unité</div>
                </div>
                <div class="d-flex align-items-center gap-2 bg-white rounded-pill border px-1 py-1">
                    <button class="btn btn-sm btn-link text-dark p-0 px-2 text-decoration-none" onclick="updateQuantity(${index}, -1)">-</button>
                    <span class="fw-bold small" style="min-width: 20px; text-align: center;">${item.quantity}</span>
                    <button class="btn btn-sm btn-link text-dark p-0 px-2 text-decoration-none" onclick="updateQuantity(${index}, 1)">+</button>
                </div>
                <div class="fw-bold ms-3" style="min-width: 60px; text-align: right;">${(item.price * item.quantity).toFixed(2)}$</div>
                <button class="btn btn-sm text-danger ms-1" onclick="removeFromCart(${index})"><i class="bi bi-x-lg"></i></button>
            </div>
            `).join('');
            document.getElementById('validateBtn').disabled = false;
        }

        const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        document.getElementById('totalAmount').textContent = total.toFixed(2) + '$';
    }

    function updateQuantity(index, change) {
        const item = cart[index];
        const newQuantity = item.quantity + change;

        if (newQuantity <= 0) {
            removeFromCart(index);
            return;
        }
        if (newQuantity > item.stock) {
            showToast('warning', 'Stock', `Limité à ${item.stock}`);
            return;
        }
        item.quantity = newQuantity;
        updateCart();
    }

    function removeFromCart(index) {
        cart.splice(index, 1);
        updateCart();
    }

    function clearCart() {
        if (cart.length === 0) return;
        if (confirm('Vider le panier ?')) {
            cart = [];
            updateCart();
        }
    }

    // Validate
    function validateSale() {
        if (cart.length === 0) return;

        const paymentMethod = document.getElementById('paymentMethod').value;
        const btn = document.getElementById('validateBtn');
        const originalContent = btn.innerHTML;

        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Traitement...';

        fetch("{% url 'sales:validate_sale' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ cart: cart, payment_method: paymentMethod })
        })
            .then(response => {
                if (response.status === 401 || response.status === 403) {
                    window.location.href = "{% url 'accounts:login' %}";
                    return Promise.reject('Auth Error');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    showToast('success', 'Vente Validée', `Total: ${data.total}$`);
                    cart = [];
                    updateCart();
                    // Redirect to receipt
                    window.location.href = data.redirect_url;
                } else {
                    showToast('error', 'Erreur', data.error);
                    btn.disabled = false;
                    btn.innerHTML = originalContent;
                }
            })
            .catch(err => {
                console.error(err);
                showToast('error', 'Erreur', 'Erreur de connexion');
                btn.disabled = false;
                btn.innerHTML = originalContent;
            });
    }

    // Utils
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Scanner
    const scanModal = new bootstrap.Modal(document.getElementById('scanFeedbackModal'));
    let scanModalTimeout;

    function showScanFeedback(success, title, message) {
        const icon = document.getElementById('scanFeedbackIcon');
        const titleEl = document.getElementById('scanFeedbackTitle');
        const contentEl = document.getElementById('scanFeedbackContent');

        if (success) {
            icon.className = 'bi bi-check-circle-fill display-1 text-success';
            titleEl.className = 'fw-bold mb-2 text-success';
        } else {
            icon.className = 'bi bi-x-circle-fill display-1 text-danger';
            titleEl.className = 'fw-bold mb-2 text-danger';
        }
        titleEl.textContent = title;
        contentEl.textContent = message;

        scanModal.show();
        clearTimeout(scanModalTimeout);
        scanModalTimeout = setTimeout(() => { scanModal.hide(); }, 1200);
    }

    // Reuse scanner logic from previous implementation
    let html5QrcodeScanner = null;
    function startScanner() {
        if (typeof Html5Qrcode === 'undefined') { alert("Scanner library missing"); return; }
        document.getElementById('scanner-overlay').style.display = 'block';
        if (html5QrcodeScanner) return;

        Html5Qrcode.getCameras().then(devices => {
            if (devices && devices.length) {
                const cameraId = devices[devices.length - 1].id;
                html5QrcodeScanner = new Html5Qrcode("reader");
                html5QrcodeScanner.start(cameraId, { fps: 20, qrbox: 250 }, onScanSuccess, onScanFailure);
            } else {
                alert("No camera found"); stopScanner();
            }
        }).catch(err => { alert("Camera error"); stopScanner(); });
    }

    function stopScanner() {
        if (html5QrcodeScanner) {
            html5QrcodeScanner.stop().then(() => {
                document.getElementById('scanner-overlay').style.display = 'none';
                html5QrcodeScanner.clear();
                html5QrcodeScanner = null;
            });
        } else {
            document.getElementById('scanner-overlay').style.display = 'none';
        }
    }

    let isScanning = false;
    function onScanSuccess(decodedText) {
        if (isScanning) return;
        isScanning = true;
        // Search API
        fetch(`/sales/api/search-products/?q=${encodeURIComponent(decodedText)}&exact=true`)
            .then(r => r.json())
            .then(data => {
                if (data.products && data.products.length > 0) {
                    const p = data.products[0];
                    addToCart(p.id, p.name, p.price, p.stock);
                    showScanFeedback(true, 'Ajouté', p.name);
                } else {
                    showScanFeedback(false, 'Inconnu', decodedText);
                }
            })
            .finally(() => setTimeout(() => { isScanning = false; }, 2000));
    }
    function onScanFailure(err) { } 
</script>
{% endblock %}