{% load static store_tags %}
<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&display=swap"
        rel="stylesheet">
    <!-- Bootstrap CSS (Keep for grid/utilities, override specific components) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Custom Modern CSS -->
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{% static 'css/des_store.css' %}?v=3.1">

    <!-- Data Injection -->
    <script>
        window.djangoProducts = JSON.parse('{{ products_json|default:"[]"|escapejs }}');
        window.storeSettings = JSON.parse('{{ store_settings_json|default:"{}"|escapejs }}');
        window.djangoCart = JSON.parse('{{ cart_json|default:"[]"|escapejs }}');
        window.csrfToken = "{{ csrf_token }}";
        window.urls = {
            checkout: "{% url 'store:checkout' %}",
            syncCart: "{% url 'store:sync_cart' %}"
        };

        // Navigation & Universe Logic
        function selectUniverse(universeName) {
            const revealOverlay = document.getElementById('categoryReveal');
            const revealTitle = document.getElementById('categoryRevealTitle');

            if (revealOverlay && revealTitle) {
                revealTitle.textContent = universeName;
                revealOverlay.classList.add('active');

                setTimeout(() => {
                    // Centralized filter call
                    if (typeof filterProductsByUniverse === 'function') {
                        filterProductsByUniverse(universeName);
                    } else {
                        // Fallback logic if function not present
                        if (typeof filters !== 'undefined') filters.category = universeName;
                        if (typeof renderCatalogueProducts === 'function') renderCatalogueProducts();
                    }

                    if (typeof showView === 'function') showView('catalogue');

                    // Update active state for nav items
                    const navItems = document.querySelectorAll('.tab-item, .pill-item');
                    navItems.forEach(item => {
                        item.classList.remove('active');
                        if (item.textContent.trim().toUpperCase() === universeName.toUpperCase() ||
                            (item.dataset && item.dataset.category === universeName)) {
                            item.classList.add('active');
                        }
                    });
                }, 500);

                setTimeout(() => {
                    revealOverlay.classList.remove('active');
                }, 1200);
            } else {
                if (typeof filterProductsByUniverse === 'function') filterProductsByUniverse(universeName);
                if (typeof showView === 'function') showView('catalogue');
            }
        }

    </script>

    <script id="django-messages-data" type="application/json">
        [
            {% for message in messages %}
            {
                "level": "{{ message.tags|escapejs }}",
                "text": "{{ message|escapejs }}"
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ]
    </script>

    <script>
        // Django Messages Injection
        const messagesData = document.getElementById('django-messages-data');
        window.djangoMessages = messagesData ? JSON.parse(messagesData.textContent) : [];
    </script>
</head>

<body>
    <!-- Premium Preloader -->
    <div id="premiumPreloader">
        <div class="preloader-content">
            <div class="preloader-logo">Mkaribu</div>
            <div class="preloader-bar">
                <div class="preloader-progress"></div>
            </div>
        </div>
    </div>

    <!-- Category Universe Reveal Overlay -->
    <div id="categoryReveal" class="category-reveal-overlay">
        <div class="category-reveal-content">
            <div class="universe-brand-name">MKARIBU PRESTIGE</div>
            <div id="categoryRevealTitle" class="category-reveal-title">Univers</div>
            <div class="category-reveal-subtitle">Chargement de la collection</div>
        </div>
    </div>
    <!-- Toast Container -->
    <div id="toastContainer"
        style="position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px;">
    </div>

    <!-- Toast Script -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if (window.djangoMessages && window.djangoMessages.length > 0) {
                window.djangoMessages.forEach(msg => {
                    showToast(msg.text, msg.level);
                });
            }
        });

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.style.padding = '1rem 2rem';
            toast.style.borderRadius = '8px';
            toast.style.color = 'white';
            toast.style.boxShadow = '0 4px 6px rgba(0,0,0,0.1)';
            toast.style.animation = 'slideInToast 0.3s ease-out';
            toast.style.fontFamily = "'Inter', sans-serif";
            toast.style.fontSize = '14px';

            if (type.includes('success')) {
                toast.style.backgroundColor = '#10b981'; // Green
            } else if (type.includes('error') || type.includes('warning')) {
                toast.style.backgroundColor = '#ef4444'; // Red
            } else {
                toast.style.backgroundColor = '#3b82f6'; // Blue
            }

            toast.textContent = message;

            const container = document.getElementById('toastContainer');
            if (container) container.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                toast.style.transition = 'all 0.3s ease-in';
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }

        const style = document.createElement('style');
        style.innerHTML = `
            @keyframes slideInToast {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
        `;
        document.head.appendChild(style);
    </script>

    <!-- Promotional Banner -->
    <div id="promoBanner" class="promo-banner" style="display: none;">
        <span id="bannerText"></span>
    </div>

    <!-- Navigation -->
    {% block header %}
    <nav class="main-nav" id="mainNav">
        <div class="nav-container">
            <div class="nav-content">
                <div class="menu-btn mobile-menu-btn" onclick="toggleMobileMenu()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="3" y1="12" x2="21" y2="12"></line>
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <line x1="3" y1="18" x2="21" y2="18"></line>
                    </svg>
                </div>

                <div class="logo" onclick="showView('home')">
                    <img src="{% static 'img/mkaribu_logo.png' %}" alt="Mkaribu"
                        style="height: 50px; object-fit: contain;">
                </div>

                <div class="desktop-menu-tabs">
                    <script>
                        // Premium Navigation - User-Defined Order
                        const mainUniverses = [
                            'IDÉES CADEAUX', 'COLLIERS', 'BRACELETS',
                            'BAGUES', 'BOUCLES D\'OREILLES', 'MONTRES', 'COMPLETS'
                        ];
                    </script>
                    <div class="category-tabs-wrapper">
                        <button
                            class="tab-item {% if not request.GET.category or request.GET.category == 'Tous' %}active{% endif %}"
                            onclick="selectUniverse('Tous')">TOUS</button>

                        {% get_active_categories as all_cats %}
                        {% for univ in "IDÉES CADEAUX,COLLIERS,BRACELETS,BAGUES,BOUCLES D'OREILLES,MONTRES,COMPLETS"|split:"," %}
                        <button class="tab-item" data-category="{{ univ }}"
                            onclick="selectUniverse('{{ univ|escapejs }}')">
                            {{ univ }}
                        </button>
                        {% endfor %}

                        {% for category in all_cats %}
                        {% if category.name|upper not in "IDÉES CADEAUX,COLLIERS,BRACELETS,BAGUES,BOUCLES D'OREILLES,MONTRES,COMPLETS" %}
                        <button class="tab-item" data-category="{{ category.name }}"
                            onclick="selectUniverse('{{ category.name|escapejs }}')">
                            {{ category.name|upper }}
                        </button>
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>

                <div class="nav-icons">
                    <button class="icon-btn search-btn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        </svg>
                    </button>
                    <button class="icon-btn cart-btn" onclick="toggleCart()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <circle cx="9" cy="21" r="1"></circle>
                            <circle cx="20" cy="21" r="1"></circle>
                            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                        </svg>
                        <span id="cartBadge" class="cart-badge">0</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Mobile Category Navigation (Horizontal Scroll) -->
    <div class="mobile-category-nav d-lg-none">
        <div class="pill-scroll-container">
            <button class="pill-item active" onclick="selectUniverse('Tous')">Tous</button>

            {% for univ in "IDÉES CADEAUX,COLLIERS,BRACELETS,BAGUES,BOUCLES D'OREILLES,MONTRES,COMPLETS"|split:"," %}
            <button class="pill-item" onclick="selectUniverse('{{ univ|escapejs }}')">
                {{ univ|title }}
            </button>
            {% endfor %}

            {% get_active_categories as mobile_all_cats %}
            {% for category in mobile_all_cats %}
            {% if category.name|upper not in "IDÉES CADEAUX,COLLIERS,BRACELETS,BAGUES,BOUCLES D'OREILLES,MONTRES,COMPLETS" %}
            <button class="pill-item" onclick="selectUniverse('{{ category.name|escapejs }}')">
                {{ category.name }}</button>
            {% endif %}
            {% endfor %}
        </div>
    </div>
    {% endblock %}

    <!-- Mobile Menu -->
    <div id="mobileMenu" class="mobile-menu">
        <div class="mobile-search">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
            <input type="text" placeholder="Rechercher...">
        </div>
        <div class="mobile-menu-items">
            <div class="mobile-category">
                <h3>Catalogue</h3>
                <div class="mobile-subcategories">
                    <button
                        onclick="showView('catalogue'); filters.category='Tous'; renderCatalogueProducts(); toggleMobileMenu()">Tout
                        voir</button>
                    {% get_active_categories as mobile_categories_fallback %}
                    {% with mobile_list=mobile_categories|default:categories|default:mobile_categories_fallback %}
                    {% for category in mobile_list %}
                    <button
                        onclick="filters.category='{{ category.name|escapejs }}'; showView('catalogue'); renderCatalogueProducts(); toggleMobileMenu()">{{
                        category.name }}</button>
                    {% empty %}
                    <span class="text-muted small px-2">Aucune catÇ¸gorie</span>
                    {% endfor %}
                    {% endwith %}
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main>
        {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    {% block footer %}
    <footer class="footer">
        <div class="footer-container">
            <div class="newsletter">
                <h4>{{ footer_config.newsletter_title|default:"Restez informé" }}</h4>
                <p>{{ footer_config.newsletter_text|default:"Inscrivez-vous pour recevoir nos nouveautés et offres
                    exclusives." }}</p>
                <div class="newsletter-form">
                    <input type="email" placeholder="Votre email">
                    <button class="btn-primary">S'inscrire</button>
                </div>
            </div>

            <div class="footer-grid">
                <div class="footer-col">
                    <img src="{% static 'img/mkaribu_logo.png' %}" alt="Mkaribu"
                        style="height: 40px; margin-bottom: 1rem;">
                    <p>{{ footer_config.company_description|default:"L'excellence artisanale depuis 2024." }}</p>
                    <div class="social-links">
                        {% for link in social_links %}
                        <a href="{{ link.url }}" aria-label="{{ link.name }}" target="_blank"><i
                                class="{{ link.icon_class }}"></i></a>
                        {% empty %}
                        <!-- Fallback or empty -->
                        {% endfor %}
                    </div>
                </div>
                <div class="footer-col">
                    <h4>Boutique</h4>
                    <ul>
                        <li><button onclick="selectUniverse('Tous')">Catalogue</button></li>
                        {% get_active_categories as f_cats %}
                        {% for category in f_cats %}
                        <li><button onclick="selectUniverse('{{ category.name|escapejs }}')">{{
                                category.name }}</button></li>
                        {% empty %}
                        <li><span class="text-muted small">Aucune catégorie</span></li>
                        {% endfor %}
                    </ul>
                </div>
                <div class="footer-col">
                    <h4>Aide</h4>
                    <ul>
                        {% for link in footer_links_help %}
                        <li><a href="{{ link.url }}">{{ link.title }}</a></li>
                        {% empty %}
                        <li><a href="#">Livraison</a></li>
                        <li><a href="#">Retours</a></li>
                        {% endfor %}
                    </ul>
                </div>
                <div class="footer-col">
                    <h4>Contact</h4>
                    <ul class="contact-list">
                        <li> <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 0 0 1 18 0z"></path>
                                <circle cx="12" cy="10" r="3"></circle>
                            </svg>
                            Route des huileries<br>
                            {{ footer_config.address|default:"N° 160, Av. Usoke, C/Lingwala"|linebreaksbr }}
                        </li>
                        <li> <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path
                                    d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z">
                                </path>
                            </svg> {{ footer_config.phone|default:"+243 97 67 977 48" }}</li>
                        <li><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z">
                                </path>
                                <polyline points="22,6 12,13 2,6"></polyline>
                            </svg>{{ footer_config.email|default:"info@mkaribu.com" }}</li>
                    </ul>
                </div>
            </div>

            <div class="footer-bottom">
                <p>{{ footer_config.copyright_text|default:"© 2024 Mkaribu Store. Tous droits réservés." }}</p>
                <div class="footer-links">
                    {% for link in footer_links_legal %}
                    <a href="{{ link.url }}">{{ link.title }}</a>
                    {% empty %}
                    <a href="#">Confidentialité</a>
                    <a href="#">CGV</a>
                    <a href="#">Mentions Légales</a>
                    {% endfor %}
                </div>
            </div>
        </div>
    </footer>
    {% endblock %}

    {% include 'store/components/cart_drawer.html' %}

    <!-- Scripts -->
    <script src="{% static 'js/des_store.js' %}?v=3.1"></script>
</body>

</html>